{% extends 'base.html' %}
{% load static %}
{% block content %}
  <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}"></script>
  <div class="container-fluid h-100">
    <div class="row h-100">
      <!-- Form Section -->
      <div class="col-md-4 form-section">
        <h1>Report</h1>
        <p>Please drag the map pin to the location of the animal for pick-up then fill out the form below and click submit. A member of the dispatch team will update you as soon as possible.</p>
        <form method="POST" action=".">
          {% csrf_token %}
          <div class="form-group">
            <label for="animal-type">Type of Animal</label>
            <select class="form-control" name="animal-type" id="animal-type">
              {% for animal_type in animal_types %}
                <option value="{{ animal_type }}" {% if case.animal == animal_type %}selected{% endif %}>{{ animal_type }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="reporter-name">Contact Name</label>
            <input type="text" class="form-control" name="reporter-name" id="reporter-name" placeholder="What's your name?" value="{{ request.user.first_name }}">
          </div>

          <div class="form-group">
            <label for="reporter-phone-number">Contact Number</label>
            <input type="text" class="form-control" name="reporter-phone-number" id="reporter-phone-number" placeholder="(555) 555-5555" value="{{ request.user.mobile_phone }}">
          </div>

          <div class="form-group">
            <label for="notes">Anything to add?</label>
            <textarea id="notes" name="notes" class="form-control" placeholder="Notes">{{ log_type }}</textarea>
          </div>

          <input type="hidden" name="coordinates" id="coordinates">
          <button type="submit" class="btn btn-primary mb-2">Submit</button>
        </form>
      </div>

      <!-- Map Section -->
      <div class="col-md-8">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script>
function initMap() {
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 16,
    // Default center - this will be updated if geolocation is successful
    center: {lat: 44.6645, lng: -63.2624}
  });

  // Try HTML5 geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      map.setCenter(userLocation);

      // Place a marker at the user's location
      var userMarker = new google.maps.Marker({
        position: userLocation,
        map: map,
        draggable: true
      });

      // Update the coordinates in the form when the marker is dragged
      google.maps.event.addListener(userMarker, 'dragend', function() {
        var draggedPosition = userMarker.getPosition();
        $('#coordinates').val(draggedPosition.lat() + ',' + draggedPosition.lng());
      });

      // Set the initial coordinates in the form
      $('#coordinates').val(userLocation.lat + ',' + userLocation.lng);

    }, function() {
      handleLocationError(true, map.getCenter());
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, map.getCenter());
  }
}

function handleLocationError(browserHasGeolocation, pos) {
  console.log(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
  // Here you can handle the error more gracefully
}

google.maps.event.addDomListener(window, 'load', initMap);
  </script>
{% endblock %}
