{% extends 'base.html' %}
{% load static %}
{% block content %}
  <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
  <div class="container-fluid h-100">
    <div class="row h-100">
      <!-- Form Section -->
      <div class="col-md-4 form-section">
        <h1>Report</h1>
        <p>Please type the address or drag the map marker to the location of the animal for pick-up then fill out the form below and click submit. A member of the dispatch team will update you as soon as possible.</p>
        <form method="POST" action=".">
          {% csrf_token %}
          <div class="form-group">
            <label for="animal-type">Type of Animal</label>
            <select class="form-control" name="animal-type" id="animal-type">
              {% for animal_type in animal_types %}
                <option value="{{ animal_type }}" {% if case.animal == animal_type %}selected{% endif %}>{{ animal_type }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="address">Address</label>
            <input type="text" class="form-control" id="address-input" placeholder="Enter address here">
          </div>

          <div class="form-group">
            <label for="reporter-name">Contact Name</label>
            <input type="text" class="form-control" name="reporter-name" id="reporter-name" placeholder="What's your name?" value="{{ request.user.first_name }}">
          </div>

          <div class="form-group">
            <label for="reporter-phone-number">Contact Number</label>
            <input type="text" class="form-control" name="reporter-phone-number" id="reporter-phone-number" placeholder="(555) 555-5555" value="{{ request.user.mobile_phone }}">
          </div>

          <div class="form-group">
            <label for="notes">Anything to add?</label>
            <textarea id="notes" name="notes" class="form-control" placeholder="Notes"></textarea>
          </div>

          <input type="hidden" name="coordinates" id="coordinates">
          <input type="hidden" name="id" value="{{ case.id }}">
          <button type="submit" class="btn btn-primary mb-2">Submit</button>
        </form>
      </div>

      <!-- Map Section -->
      <div class="col-md-8">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

 <script>
function initMap() {
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 16,
    center: {lat: 44.6645, lng: -63.2624}
  });

  var geocoder = new google.maps.Geocoder();
  var autocomplete = new google.maps.places.Autocomplete(document.getElementById('address-input'));
  autocomplete.bindTo('bounds', map);

  var marker = new google.maps.Marker({
    map: map,
    draggable: true,
    position: map.getCenter() // Initial marker position
  });

  // Try HTML5 geolocation to set initial marker position
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      map.setCenter(userLocation);
      marker.setPosition(userLocation);
      updateCoordinates(userLocation);
    }, function() {
      handleLocationError(true, map.getCenter());
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, map.getCenter());
  }

  // Autocomplete listener
  autocomplete.addListener('place_changed', function() {
    var place = autocomplete.getPlace();
    if (!place.geometry) {
      window.alert("No details available for input: '" + place.name + "'");
      return;
    }

    if (place.geometry.viewport) {
      map.fitBounds(place.geometry.viewport);
    } else {
      map.setCenter(place.geometry.location);
      map.setZoom(17);
    }

    marker.setPosition(place.geometry.location);
    updateCoordinates(place.geometry.location);
  });

  // Marker drag listener
  google.maps.event.addListener(marker, 'dragend', function() {
    geocoder.geocode({'location': marker.getPosition()}, function(results, status) {
      if (status === 'OK') {
        if (results[0]) {
          document.getElementById('address-input').value = results[0].formatted_address;
          updateCoordinates(marker.getPosition());
        } else {
          window.alert('No results found');
        }
      } else {
        window.alert('Geocoder failed due to: ' + status);
      }
    });
  });

  function updateCoordinates(location) {
    // Check if location has lat and lng as functions (LatLng object)
    if (typeof location.lat === 'function' && typeof location.lng === 'function') {
      $('#coordinates').val(location.lat() + ',' + location.lng());
    }
    // If location is a plain object with lat and lng properties
    else if ('lat' in location && 'lng' in location) {
      $('#coordinates').val(location.lat + ',' + location.lng);
    }
    else {
      console.error('Invalid location object passed to updateCoordinates');
    }
  }

  function handleLocationError(browserHasGeolocation, pos) {
    console.log(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
    // Here you can handle the error more gracefully
  }
}

google.maps.event.addDomListener(window, 'load', initMap);
</script>
{% endblock %}
