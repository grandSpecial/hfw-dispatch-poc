{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container-fluid">
	<div class="row">
		<div class="col-3">
			{% for case in cases %}
			<div class="case-block">
				<div class="case-content">
					<p>{{ case.animal }}</p>
					<p>{% firstof case.0.updated_on case.created_on %}</p>
					<p>{{ case.0.log.messages_sent }}</p>
					<!-- <p>{{ case.log.0.status }}</p> -->
				</div>
				<div class="case-buttons">
					<a href="{% url 'c' case.id %}" class="btn btn-sm btn-primary mb-2">Details</a>
					<button class="btn btn-sm btn-secondary" onclick="goto({{ case.log.0.coordinates.0 }},{{ case.log.0.coordinates.1 }});">Focus</button>
				</div>
			</div>
			{% endfor %}
		</div>
		<div class="col">
			<div id="map"></div>
		</div>
	</div>
</div>

<script>
var map;

function initMap() {
  	map = new google.maps.Map(document.getElementById('map'), {
	zoom: 8,
	center: {lat: 44.6645, lng: -63.2624} // Adjust as needed
  });

  var data = {{ map_data|safe }};
  data.forEach(item => {
    var coords = item.coordinates.map(Number); // Convert coordinates to numbers

    // Determine the color based on the status
    var color = item.status === 'reported' ? '#ff0000' : (item.status === 'waiting' ? '#ffff00' : '#00ff00');

    // Create a marker using the createMarker function
    createMarker({lat: coords[0], lng: coords[1]}, item.Animals, color);
  });
}

function createMarker(coords, label, color = "#00ff00", isUser = false) {
  var marker = new google.maps.Marker({
    position: coords,
    map: map,
    title: label,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: isUser ? 10 : 8,
      fillColor: color,
      fillOpacity: 0.8,
      strokeWeight: 0
    }
  });

  var infowindow = new google.maps.InfoWindow({
    content: label
  });

  marker.addListener('click', function() {
    infowindow.open(map, marker);
  });
}

function goto(lat, lng) {
  var coords = {
    lat: lat,
    lng: lng
  };
  map.setCenter(coords);
  map.setZoom(14); // Adjust as needed
}

// Load the Google Maps API with the callback to initMap
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap"></script>

{% endblock %}
